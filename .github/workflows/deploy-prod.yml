name: Deploy to Production

on:
  # Manual trigger from the Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to MLX production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MLX_HOST }}
          username: ${{ secrets.MLX_USER }}      # should be "mistresslotusx"
          password: ${{ secrets.MLX_PASSWORD }}  # NEW: using password instead of key
          port: 22
          script: |
            # Go to your production app folder
            cd /home/mistresslotusx/htdocs/mistresslotusx.com/app

            # Allow git to trust this directory (fixes "dubious ownership" error)
            git config --global --add safe.directory /home/mistresslotusx/htdocs/mistresslotusx.com/app

            # Sync code from GitHub main branch
            git fetch origin
            git reset --hard origin/main

            # Install dependencies (omit devDependencies in production)
            npm install --omit=dev

            # Build the Next.js app
            npm run build

            # Restart PM2 process for production
            pm2 restart mlx-prod || echo "PM2 process 'mlx-prod' not found, please restart your prod process manually."
